{% extends "base.html" %}

{% block content %}
<title>{{ title }} - {{ video.title }}</title>
<div class="container mt-4">
    
    <!-- 视频播放区 -->
    <div class="card shadow-lg">
        <div class="card-body">
            <h3 class="card-title mb-4 text-center">播放视频</h3>
            <div id="art-player" class="rounded overflow-hidden"></div>
        </div>
    </div>
    
    <!-- 视频信息区 -->
    <div class="card shadow-lg mb-4">
        <div class="row g-0">
            <!-- 视频封面 -->
            <div class="col-md-4">
                <img src="{{ url_for('static', filename='uploads/covers/' + video.cover_filename) }}" 
                     class="card-img-top rounded-start" 
                     alt="封面图片">
            </div>
            <!-- 视频详细信息 -->
            <div class="col-md-8">
                <div class="card-body">
                    <h1 class="card-title text-primary mb-3">{{ video.title }}</h1>
                    <p class="card-text">{{ video.description }}</p>
                    <ul class="list-unstyled text-muted mb-4">
                        <li>
                            <strong>上传者:</strong> 
                            <a target="_blank" href="{{ url_for('user_profile', username=video.uploader) }}" class="text-decoration-none">
                                <img src="{{ url_for('static', filename='uploads/avatars/' + uploader.avatar_filename) if uploader.avatar_filename else url_for('static', filename='images/default_avatar.png') }}" 
                                     alt="上传者头像" class="rounded-circle" style="width: 30px; height: 30px;">
                                <span class="ms-2">{{ video.uploader }}</span>
                            </a>
                        </li>
                        <li><strong>上传时间:</strong> {{ video.upload_time }}</li>
                        <li><strong>播放次数:</strong> {{ video.play_count }}</li>
                        <li><font color="#FF0000">视频由用户自主上传，与该平台无关</font></li>
                    </ul>
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">返回主页</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 评论区 -->
    <div class="card shadow-lg mb-4">
        <div class="card-body">
            <h3 class="card-title mb-4 text-center">评论区</h3>
            {% if session.logged_in %}
                <form action="{{ url_for('comment') }}" method="POST" class="mb-4">
                    <input type="hidden" name="video_filename" value="{{ video.video_filename }}">
                    <div class="form-group">
                        <textarea name="comment_text" class="form-control" rows="3" placeholder="发表评论..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">发送评论</button>
                </form>
            {% else %}
                <p class="text-center">请先<a href="{{ url_for('login', next=url_for('play', video_filename=video.video_filename)) }}">登录</a>后再发表评论。</p>
            {% endif %}

            <!-- 评论列表 -->
            <ul class="list-group">
                {% for comment in comments %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ comment.username }}</strong> ({{ comment.comment_time }}): {{ comment.comment_text }}
                        </div>
                        <div>
                            <span class="badge bg-secondary me-2">点赞数：{{ comment.likes }}</span>
                            {% if session.logged_in %}
                                <form action="{{ url_for('like_comment') }}" method="POST" style="display:inline;">
                                    <input type="hidden" name="video_filename" value="{{ video.video_filename }}">
                                    <input type="hidden" name="comment_index" value="{{ loop.index0 }}">
                                    {% if session['user_id'] in comment.liked_by %}
                                        <button type="button" class="btn btn-sm btn-light disabled">已点赞</button>
                                    {% else %}
                                        <button type="submit" class="btn btn-sm btn-light">点赞</button>
                                    {% endif %}
                                </form>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<!-- ArtPlayer 依赖 -->
<link href="{{ url_for('static', filename='css/artplayer.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='js/artplayer.js') }}"></script>
<script src="{{ url_for('static', filename='js/flv.js') }}"></script>
<script src="{{ url_for('static', filename='js/hls.js') }}"></script>

<style>
    /* 播放器容器样式 */
    #art-player {
        width: 100%;
        height: 500px;
        border-radius: 10px;
        overflow: hidden;
        background: #000;
    }

    /* 自定义图标样式 */
    .art-icon-loading img,
    .art-icon-state img,
    .art-icon-indicator img {
        vertical-align: middle;
        object-fit: contain;
    }

    .art-icon-loading img {
        width: 40px !important;
        height: 40px !important;
    }

    .art-icon-state img {
        width: 150px !important;
        height: 150px !important;
    }

    .art-icon-indicator img {
        width: 16px !important;
        height: 16px !important;
    }
</style>

<script>
    // 初始化 ArtPlayer
    const art = new Artplayer({
        container: '#art-player',
        url: "{{ url_for('static', filename='uploads/videos/' + video.video_filename) }}",
        title: '{{ video.title }}',
        poster: "{{ url_for('static', filename='uploads/covers/' + video.cover_filename) }}",
        volume: 0.5,
        isLive: false,
        autoplay: false,
        autoSize: true,
        autoMini: true,
        screenshot: true,
        setting: true,
        loop: false,
        flip: true,
        playbackRate: true,
        aspectRatio: true,
        fullscreen: true,
        fullscreenWeb: true,
        subtitleOffset: true,
        miniProgressBar: true,
        mutex: true,
        backdrop: true,
        theme: '#2196F3',
        /*icons: {
            loading: '<img src="{{ url_for("static", filename="images/player/loading.gif") }}">',
            state: '<img src="{{ url_for("static", filename="images/player/state.svg") }}">',
            indicator: '<img src="{{ url_for("static", filename="images/player/indicator.svg") }}">'
        },
        */
        moreVideoAttr: {
            crossOrigin: 'anonymous',
        },
        customType: {
            hls: function(video, url) {
                const hls = new Hls({
                    enableWorker: true,
                    maxBufferLength: 30,
                    maxMaxBufferLength: 600,
                });
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('HLS Error:', data);
                    art.notice.show('视频加载失败，请检查格式兼容性', 3000);
                });
            },
            flv: function(video, url) {
                const flvPlayer = flvjs.createPlayer({
                    type: 'flv',
                    url: url,
                    isLive: false,
                    hasAudio: true,
                    hasVideo: true,
                });
                flvPlayer.attachMediaElement(video);
                flvPlayer.load();
                flvPlayer.on(flvjs.Events.ERROR, (errType, errDetail) => {
                    console.error('FLV Error:', errType, errDetail);
                    art.notice.show('FLV格式加载失败', 3000);
                });
            }
        },
        plugins: [
            artplayerPluginQuality({
                // 清晰度切换插件配置
                control: true,
                setting: true,
                getResolution: (video) => [
                    {
                        default: true,
                        html: '自动',
                        url: video.url,
                    },
                ],
            }),
        ],
    });

    // ================= 事件监听 =================
    // 播放进度保存
    art.on('video:timeupdate', () => {
        localStorage.setItem('videoProgress-{{ video.video_filename }}', art.currentTime);
    });

    // 恢复播放进度
    const savedTime = localStorage.getItem('videoProgress-{{ video.video_filename }}');
    if (savedTime) {
        art.seek(parseFloat(savedTime));
    }

    // 播放统计
    art.on('video:play', () => {
        navigator.sendBeacon('/api/play-count/{{ video.video_filename }}');
    });

    // 错误处理
    art.on('video:error', (error) => {
        console.error('播放错误:', error);
        art.notice.show('视频加载失败，请尝试以下操作：<br>1. 刷新页面<br>2. 更换浏览器', 5000);
    });

    // 分辨率变化监听
    art.on('video:resize', (size) => {
        console.log('当前分辨率:', size.width + 'x' + size.height);
    });

    // 快捷键支持
    art.on('keydown:space', (event) => {
        art.toggle();
        event.preventDefault();
    });

    // 全屏变化监听
    art.on('fullscreen', (state) => {
        console.log('全屏状态:', state);
    });

    // ================= 扩展功能 =================
    // 自定义右键菜单
    art.contextmenu.add({
        name: '视频信息',
        callback: () => {
            art.notice.show(`
                <div style="text-align: left; padding: 10px">
                    <p>标题：{{ video.title }}</p>
                    <p>上传者：{{ video.uploader }}</p>
                    <p>格式：${art.isVideo ? video.videoFilename.split('.').pop().toUpperCase() : '未知'}</p>
                    <p>分辨率：${art.video.videoWidth}x${art.video.videoHeight}</p>
                </div>
            `, 4000);
        }
    });

    /* 播放结束处理
    art.on('video:ended', () => {
        art.notice.show('播放结束，即将推荐相似视频...', 3000);
        setTimeout(() => {
            // 这里可以添加推荐视频逻辑
        }, 3000);
    });
    */

    // 网络状态检测
    window.addEventListener('online', () => {
        art.notice.show('网络已恢复', 2000);
    });

    window.addEventListener('offline', () => {
        art.notice.show('网络连接已断开', 3000);
    });
</script>
{% endblock %}